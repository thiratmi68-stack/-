//จองคิวตรวจรักษา

<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>จองคิวตรวจ | Medical Queue</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />

  <style>
    body {
      font-family: "Sarabun", sans-serif;
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">
  <script>
    // ตรวจสอบการเข้าสู่ระบบ - ถ้าไม่ได้เข้าสู่ระบบ ให้ไปหน้า login
    (function () {
      try {
        const user = JSON.parse(localStorage.getItem('mq_user'));
        if (!user || !user.name) {
          alert('กรุณาเข้าสู่ระบบก่อนจองคิว');
          window.location.href = 'index.html';
        } else {
          // เก็บชื่อผู้ใช้งานสำหรับใช้ในฟอร์ม
          localStorage.setItem('mq_patientName', user.name);
        }
      } catch (e) {
        alert('กรุณาเข้าสู่ระบบก่อนจองคิว');
        window.location.href = 'index.html';
      }
    })();
  </script>

  <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <a href="home.html" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
        <div class="w-9 h-9 rounded-full border border-blue-500 flex items-center justify-center">
          <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M3 12h4l3-6 4 12 3-6h4" />
          </svg>
        </div>
        <div>
          <p class="font-bold text-blue-600 leading-none">Medical Queue</p>
          <p class="text-sm text-gray-500">ระบบจองคิวออนไลน์</p>
        </div>
      </a>

      <ul class="hidden md:flex gap-10 text-gray-700 font-medium">
        <li>
          <a href="home.html"
            class="border-b-2 border-transparent pb-1 hover:text-blue-600 hover:border-blue-600 transition-colors">หน้าหลัก</a>
        </li>
        <li>
          <a href="booking.html"
            class="border-b-2 border-transparent pb-1 hover:text-blue-600 hover:border-blue-600 transition-colors">จองคิวตรวจ</a>
        </li>
        <li>
          <a href="myticket.html"
            class="border-b-2 border-transparent pb-1 hover:text-blue-600 hover:border-blue-600 transition-colors">ตัวของฉัน</a>
        </li>

        <li>
          <a href="history.html"
            class="border-b-2 border-transparent pb-1 hover:text-blue-600 hover:border-blue-600 transition-colors">ประวัติ</a>
        </li>

        <li>
          <a href="notification.html"
            class="border-b-2 border-transparent pb-1 hover:text-blue-600 hover:border-blue-600 transition-colors">แจ้งเตือน</a>
        </li>
      </ul>

      <div class="flex items-center gap-4">
        <a id="userStatusLink" href="index.html"
          class="text-blue-600 font-medium hover:underline text-sm md:text-base">ลงทะเบียน / เข้าสู่ระบบ</a>
        <div id="userMenuBtn"
          class="w-9 h-9 border rounded-full flex items-center justify-center hover:bg-gray-100 cursor-pointer transition-colors bg-white hidden">
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
            <circle cx="12" cy="7" r="4" />
          </svg>
        </div>
      </div>
    </div>
  </nav>

  <!-- ----------------------------------------------------------------- -->

  <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 py-8 w-full">
    <div class="mb-8">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">
        จองคิวตรวจรักษา
      </h1>

      <div class="flex items-center justify-between relative max-w-3xl mx-auto mb-10">
        <div class="absolute left-0 top-1/2 transform -translate-y-1/2 w-full h-1 bg-gray-200 -z-10"></div>

        <div class="flex flex-col items-center bg-gray-50 px-2">
          <div
            class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold mb-2 shadow-md">
            1
          </div>
          <span class="text-xs md:text-sm font-medium text-blue-800">เลือกแผนก/แพทย์</span>
        </div>
        <div class="flex flex-col items-center bg-gray-50 px-2">
          <div
            class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white border-2 border-blue-600 text-blue-600 flex items-center justify-center font-bold mb-2">
            2
          </div>
          <span class="text-xs md:text-sm font-medium text-gray-500">วันเวลา</span>
        </div>
        <div class="flex flex-col items-center bg-gray-50 px-2">
          <div
            class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white border-2 border-gray-300 text-gray-400 flex items-center justify-center font-bold mb-2">
            3
          </div>
          <span class="text-xs md:text-sm font-medium text-gray-500">ยืนยัน</span>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-2 space-y-6">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <label class="block text-gray-700 font-bold mb-3 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
              </path>
            </svg>
            เลือกแผนกที่ต้องการรักษา
          </label>
          <select id="departmentSelect"
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
            <option value="" disabled selected>กรุณาเลือกแผนก</option>
            <option value="med">อายุรกรรมทั่วไป (Internal Medicine)</option>
            <option value="dent">ทันตกรรม (Dental)</option>
            <option value="ortho">ศัลยกรรมกระดูก (Orthopedics)</option>
            <option value="pedia">กุมารเวชกรรม (Pediatrics)</option>
          </select>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h3 class="text-gray-700 font-bold mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            เลือกแพทย์ (ถ้ามี)
          </h3>

          <div id="doctorContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <p class="text-gray-500 col-span-full text-center py-4">กรุณาเลือกแผนกเพื่อดูรายชื่อแพทย์</p>
          </div>
          <div class="mt-4 text-center">
            <button class="text-sm text-gray-500 hover:text-blue-600 underline">
              ไม่ระบุแพทย์ (แพทย์ท่านใดก็ได้)
            </button>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <label class="block text-gray-700 font-bold mb-3">อาการเบื้องต้น / สาเหตุที่มาตรวจ</label>
          <textarea id="symptoms" rows="3"
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="เช่น มีไข้สูง ปวดหัว ตัวร้อน เป็นมา 2 วัน..."></textarea>
        </div>

        <button id="nextBtn"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition transform hover:-translate-y-0.5">
          ถัดไป
        </button>
      </div>


    </div>
    </div>
  </main>

  <!-- ----------------------------------------------------------------- -->

  <footer class="bg-white border-t border-gray-200 py-6 mt-8">
    <div class="max-w-7xl mx-auto px-6 text-center">
      <p class="text-gray-500 text-sm">
        &copy; 2024 Medical Queue System. ระบบจองคิวโรงพยาบาลออนไลน์
      </p>
    </div>
  </footer>
  <script>
    (function () {
      const nextBtn = document.getElementById('nextBtn');
      const leftContainer = document.getElementById('dateContainerLeft');
      const rightContainer = document.getElementById('dateContainerRight');
      const leftInput = document.getElementById('appointmentDate');
      const rightInput = document.getElementById('appointmentDateRight');

      if (!nextBtn) return;

      nextBtn.addEventListener('click', function (e) {
        e.preventDefault();
        // gather current selections and save to localStorage
        try {
          const deptEl = document.getElementById('departmentSelect');
          const deptValue = deptEl ? deptEl.value : '';
          const deptText = deptEl ? (deptEl.options[deptEl.selectedIndex]?.text || '') : '';
          const symptomsVal = document.getElementById('symptoms')?.value || '';
          const dateValLeft = leftInput ? leftInput.value : '';
          const selectedDoctorEl = document.querySelector('.doctor-card.selected');
          const doctorName = selectedDoctorEl ? selectedDoctorEl.dataset.name : '';

          localStorage.setItem('mq_departmentValue', deptValue);
          localStorage.setItem('mq_departmentName', deptText);
          localStorage.setItem('mq_doctorName', doctorName);
          localStorage.setItem('mq_symptoms', symptomsVal);
          if (dateValLeft) localStorage.setItem('mq_date', dateValLeft);
        } catch (err) {/* ignore */ }

        // navigate to datetime (preserve date in query if present)
        const dateVal = leftInput ? leftInput.value : '';
        const target = dateVal ? ('datetime.html?date=' + encodeURIComponent(dateVal)) : 'datetime.html';
        window.location.href = target;
      });
      // navigate to datetime page when right-card button clicked
      const goToDatetime = document.getElementById('goToDatetime');
      if (goToDatetime) {
        goToDatetime.addEventListener('click', function () {
          window.location.href = 'datetime.html';
        });
      }
      // doctor card selection
      document.querySelectorAll('.doctor-card').forEach(card => {
        card.addEventListener('click', function () {
          document.querySelectorAll('.doctor-card').forEach(c => c.classList.remove('selected', 'border-blue-500', 'bg-blue-50'));
          this.classList.add('selected', 'border-blue-500', 'bg-blue-50');
        });
      });
    })();
    // เลือกแพทย์ตามแผนก
    (function () {
      const departmentSelect = document.getElementById('departmentSelect');
      const doctorContainer = document.getElementById('doctorContainer');

      if (departmentSelect && doctorContainer) {
        departmentSelect.addEventListener('change', async function () {
          const department = this.value;
          doctorContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">กำลังโหลดข้อมูล...</p>';

          try {
            const response = await fetch('/api/doctors?department=' + department);
            const doctors = await response.json();

            doctorContainer.innerHTML = '';

            if (doctors.length === 0) {
              doctorContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">ไม่พบรายชื่อแพทย์ในแผนกนี้</p>';
              return;
            }

            doctors.forEach(doctor => {
              const card = document.createElement('div');
              const isFull = doctor.status.includes('เต็ม');

              card.className = 'border border-gray-200 rounded-lg p-4 transition doctor-card relative';
              if (isFull) {
                card.className += ' opacity-50 cursor-not-allowed bg-gray-50';
              } else {
                card.className += ' cursor-pointer hover:border-blue-300 hover:shadow-md';
              }

              card.dataset.name = doctor.name;

              card.innerHTML = `
                  <div class="flex items-center gap-4">
                    <div>
                      <p class="font-bold text-gray-800">${doctor.name}</p>
                      <p class="text-xs text-gray-500">${doctor.specialty}</p>
                      <p class="text-xs ${doctor.status_color} mt-1">${doctor.status}</p>
                    </div>
                  </div>
                  <div class="selected-icon absolute top-3 right-3 text-blue-600 hidden">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                      <path
                        fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                        clip-rule="evenodd"
                      ></path>
                    </svg>
                  </div>
                `;

              // Add click event for selection only if not full
              if (!isFull) {
                card.addEventListener('click', function () {
                  document.querySelectorAll('.doctor-card').forEach(c => {
                    c.classList.remove('selected', 'border-blue-500', 'bg-blue-50', 'border-2');
                    c.classList.add('border', 'border-gray-200');
                    if (!c.classList.contains('opacity-50')) c.classList.add('hover:border-blue-300', 'hover:shadow-md');
                    const icon = c.querySelector('.selected-icon');
                    if (icon) icon.classList.add('hidden');
                  });

                  this.classList.remove('border', 'border-gray-200', 'hover:border-blue-300', 'hover:shadow-md');
                  this.classList.add('selected', 'border-blue-500', 'bg-blue-50', 'border-2');
                  const icon = this.querySelector('.selected-icon');
                  if (icon) icon.classList.remove('hidden');
                });
              }

              doctorContainer.appendChild(card);
            });

          } catch (e) {
            console.error(e);
            doctorContainer.innerHTML = '<p class="text-red-500 col-span-full text-center py-4">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>';
          }
        });
      }
    })();

    // ดึงข้อมูลผู้ใช้งาน และตั้งชื่อผู้ป่วยอัตโนมัติ
    (function () {
      try {
        const user = JSON.parse(localStorage.getItem('mq_user'));
        if (user && user.name) {
          localStorage.setItem('mq_patientName', user.name);
        }
      } catch (e) { }
    })();
    // ตรวจสอบสถานะการเข้าสู่ระบบและแสดงชื่อผู้ใช้งาน
    (function () {
      const userStatusLink = document.getElementById('userStatusLink');
      const userMenuBtn = document.getElementById('userMenuBtn');

      try {
        const user = JSON.parse(localStorage.getItem('mq_user'));
        if (user && user.name) {
          userStatusLink.textContent = user.name;
          userStatusLink.href = '#';
          userStatusLink.style.cursor = 'pointer';
          userMenuBtn.classList.remove('hidden');

          userStatusLink.addEventListener('click', function (e) {
            e.preventDefault();
            if (confirm('ออกจากระบบ?')) {
              localStorage.removeItem('mq_user');
              localStorage.removeItem('mq_registeredUser');
              window.location.reload();
            }
          });
        }
      } catch (e) {
        // ไม่มีข้อมูล user ให้แสดงลิงก์ปกติ
      }
    })();
  </script>
</body>

</html>