////จองคิวตรวจรักษา

<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>จองคิวตรวจ | Medical Queue</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />

  <style>
    body {
      font-family: "Sarabun", sans-serif;
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">
  <script>
    // ตรวจสอบการเข้าสู่ระบบ - ถ้าไม่ได้เข้าสู่ระบบ ให้ไปหน้า login
    (function () {
      try {
        const user = JSON.parse(localStorage.getItem('mq_user'));
        if (!user || !user.name) {
          alert('กรุณาเข้าสู่ระบบก่อนจองคิว');
          window.location.href = 'index.html';
        } else {
          // เก็บชื่อผู้ใช้งานสำหรับใช้ในฟอร์ม
          localStorage.setItem('mq_patientName', user.name);
        }
      } catch (e) {
        alert('กรุณาเข้าสู่ระบบก่อนจองคิว');
        window.location.href = 'index.html';
      }
    })();
  </script>

  <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <a href="home.html" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
        <div class="w-9 h-9 rounded-full border border-blue-500 flex items-center justify-center">
          <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M3 12h4l3-6 4 12 3-6h4" />
          </svg>
        </div>
        <div>
          <p class="font-bold text-blue-600 leading-none">Medical Queue</p>
          <p class="text-sm text-gray-500">ระบบจองคิวออนไลน์</p>
        </div>
      </a>

      <ul class="hidden md:flex gap-10 text-gray-700 font-medium">
        <li>
          <a href="home.html"
            class="border-b-2 border-transparent pb-1 hover:text-blue-600 hover:border-blue-600 transition-colors">หน้าหลัก</a>
        </li>
        <li>
          <a href="booking.html"
            class="border-b-2 border-transparent pb-1 hover:text-blue-600 hover:border-blue-600 transition-colors">จองคิวตรวจ</a>
        </li>
        <li>
          <a href="myticket.html"
            class="border-b-2 border-transparent pb-1 hover:text-blue-600 hover:border-blue-600 transition-colors">เมนูคิว</a>
        </li>

        <li>
          <a href="history.html"
            class="border-b-2 border-transparent pb-1 hover:text-blue-600 hover:border-blue-600 transition-colors">ประวัติ</a>
        </li>

        <li>
          <a href="notification.html"
            class="border-b-2 border-transparent pb-1 hover:text-blue-600 hover:border-blue-600 transition-colors">แจ้งเตือน</a>
        </li>
      </ul>

      <div class="flex items-center gap-4">
        <a id="userStatusLink" href="index.html"
          class="text-blue-600 font-medium hover:underline text-sm md:text-base">ลงทะเบียน / เข้าสู่ระบบ</a>
        <div id="userMenuBtn"
          class="w-9 h-9 border rounded-full flex items-center justify-center hover:bg-gray-100 cursor-pointer transition-colors bg-white hidden">
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
            <circle cx="12" cy="7" r="4" />
          </svg>
        </div>
      </div>
    </div>
  </nav>

  <!-- ----------------------------------------------------------------- -->

  <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 py-8 w-full">
    <div class="mb-8">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">
        จองคิวตรวจรักษา
      </h1>

      <div class="flex items-center justify-between relative max-w-xl mx-auto mb-10">
        <div class="absolute left-0 top-1/2 transform -translate-y-1/2 w-full h-1 bg-gray-200 -z-10"></div>

        <div class="flex flex-col items-center bg-gray-50 px-2">
          <div
            class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold mb-2 shadow-md">
            1
          </div>
          <span class="text-xs md:text-sm font-medium text-blue-800">ระบุข้อมูลการจอง</span>
        </div>
        <div class="flex flex-col items-center bg-gray-50 px-2">
          <div
            class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white border-2 border-gray-300 text-gray-400 flex items-center justify-center font-bold mb-2">
            2
          </div>
          <span class="text-xs md:text-sm font-medium text-gray-500">ยืนยันข้อมูล</span>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Left Column: Doctor & Dept -->
      <div class="space-y-6">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <label class="block text-gray-700 font-bold mb-3 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
              </path>
            </svg>
            เลือกแผนกที่ต้องการรักษา
          </label>
          <select id="departmentSelect"
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
            <option value="" disabled selected>กรุณาเลือกแผนก</option>
            <option value="med">อายุรกรรมทั่วไป</option>
            <option value="dent">ทันตกรรม</option>
            <option value="ortho">ศัลยกรรมกระดูก</option>
            <option value="pedia">กุมารเวชกรรม</option>
          </select>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h3 class="text-gray-700 font-bold mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            เลือกแพทย์
          </h3>

          <div id="doctorContainer"
            class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[400px] overflow-y-auto no-scrollbar">
            <p class="text-gray-500 col-span-full text-center py-4">กรุณาเลือกแผนกเพื่อดูรายชื่อแพทย์</p>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <label class="block text-gray-700 font-bold mb-3">อาการเบื้องต้น / สาเหตุที่มาตรวจ</label>
          <textarea id="symptoms" rows="3"
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="เช่น มีไข้สูง ปวดหัว ตัวร้อน เป็นมา 2 วัน..."></textarea>
        </div>
      </div>

      <!-- Right Column: Date & Time -->
      <div class="space-y-6">
        <div id="dateTimeSection" class="opacity-50 pointer-events-none transition-opacity duration-300">
          <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6 transition-all duration-300">
            <label class="block text-gray-700 font-bold mb-3 flex items-center gap-2">
              <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              วันที่นัดหมาย
            </label>
            <input id="date" type="date"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-gray-700" />
          </div>

          <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6 transition-all duration-300">
            <label class="block text-gray-700 font-bold mb-3 flex items-center gap-2">
              <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              เลือกช่วงเวลา
            </label>
            <div id="timeGrid" class="grid grid-cols-2 md:grid-cols-3 gap-3">
              <p class="col-span-full text-gray-400 text-center py-4 text-sm">กรุณาเลือกวันที่นัดหมายก่อน</p>
            </div>
          </div>
        </div>

        <button id="nextBtn" disabled
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed">
          สรุปข้อมูลการจอง
        </button>
      </div>


    </div>
    </div>
  </main>

  <!-- ----------------------------------------------------------------- -->

  <footer class="bg-white border-t border-gray-200 py-6 mt-8">
    <div class="max-w-7xl mx-auto px-6 text-center">
      <p class="text-gray-500 text-sm">
        &copy; 2024 Medical Queue System. ระบบจองคิวโรงพยาบาลออนไลน์
      </p>
    </div>
  </footer>
  <script>
    // -------------------------------------------------------------------------
    // 0. Active Booking Check (1 Person 1 Ticket)
    // -------------------------------------------------------------------------
    (async function () {
      const rescheduleId = localStorage.getItem('mq_rescheduleBookingId');
      if (rescheduleId) return; // Allow if rescheduling

      try {
        // Check if user has active bookings
        const user = JSON.parse(localStorage.getItem('mq_user'));
        if (!user) return; // login check handles redirect usually

        // We need to fetch user's bookings.
        // API endpoint `/api/bookings` returns all? No, checking code:
        // It returns all. We filter in frontend. (Not ideal for sec but matches current app).

        const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? (location.protocol + '//' + location.hostname + ':5000') : '';
        const res = await fetch(API_BASE + '/api/bookings');
        const bookings = await res.json();

        // Filter for this user AND active status
        const myActive = bookings.filter(b => {
          const isMine = (b.patient_name === user.name) || (b.id_users === user.id);
          // Note: API returns patient_name not id_users always? 
          // Let's check typical response.
          // Actually `list_bookings` in backend (not shown in snippet) probably returns mixed.
          // Safer to matches name for now as per `myticket.html` logic.
          const isNameMatch = (b.patient_name || '').trim() === user.name.trim();

          const isActive = ['booked', 'pending', 'rescheduled', 'รอรับบริการ'].includes(b.status);
          return isNameMatch && isActive;
        });

        if (myActive.length > 0) {
          alert('ท่านมีคิวที่จองไว้อยู่แล้ว กรุณายกเลิกคิวเดิมก่อนจองใหม่');
          window.location.href = 'myticket.html';
        }

      } catch (e) { console.error("Active check error", e); }
    })();

    // Constants & Global State
    let selectedDoctorId = null;
    let selectedSlotId = null;
    let selectedTimeString = null;

    // -------------------------------------------------------------------------
    // 1. Navigation & Validation Logic
    // -------------------------------------------------------------------------
    (function () {
      const nextBtn = document.getElementById('nextBtn');
      const dateInput = document.getElementById('date');

      if (!nextBtn) return;

      // Enable/Disable Next Button
      window.updateNextButtonState = function () {
        // Must select Department, Doctor, Date, Time (Slot) & optionally Symptoms
        const deptVal = document.getElementById('departmentSelect').value;
        const symptomsVal = document.getElementById('symptoms').value;
        const dateVal = dateInput.value;

        let isValid = deptVal && selectedDoctorId && dateVal && selectedSlotId;

        nextBtn.disabled = !isValid;
      };

      // Add Listener to Inputs to trigger validation
      document.getElementById('departmentSelect').addEventListener('change', window.updateNextButtonState);
      document.getElementById('symptoms').addEventListener('input', window.updateNextButtonState);
      document.getElementById('date').addEventListener('change', window.updateNextButtonState);


      nextBtn.addEventListener('click', function (e) {
        e.preventDefault();

        try {
          // Gather Data
          const deptEl = document.getElementById('departmentSelect');
          const deptValue = deptEl.value;
          const deptText = deptEl.options[deptEl.selectedIndex]?.text || '';
          const symptomsVal = document.getElementById('symptoms').value;
          const dateVal = dateInput.value;

          const doctorCard = document.querySelector(`.doctor-card[data-id="${selectedDoctorId}"]`);
          const doctorName = doctorCard ? doctorCard.dataset.name : '';

          // Validate again just in case
          if (!deptValue || !selectedDoctorId || !dateVal || !window.selectedSlotId) {
            alert('กรุณากรอกข้อมูลให้ครบถ้วน');
            return;
          }

          // Save to LocalStorage
          localStorage.setItem('mq_departmentValue', deptValue);
          localStorage.setItem('mq_departmentName', deptText);
          localStorage.setItem('mq_doctorName', doctorName); // Still needed for confirm page display
          localStorage.setItem('mq_doctorId', selectedDoctorId); // Store ID for backend
          localStorage.setItem('mq_symptoms', symptomsVal);
          localStorage.setItem('mq_date', dateVal);
          localStorage.setItem('mq_time', window.selectedTimeString);
          localStorage.setItem('mq_slot_id', window.selectedSlotId);

          // Navigate
          window.location.href = 'confirm.html';

        } catch (err) {
          console.error("Navigation Error", err);
          alert("เกิดข้อผิดพลาด");
        }
      });
    })();

    // -------------------------------------------------------------------------
    // 2. Department & Doctor Selection Logic
    // -------------------------------------------------------------------------
    (function () {
      const departmentSelect = document.getElementById('departmentSelect');
      const doctorContainer = document.getElementById('doctorContainer');
      const dateTimeSection = document.getElementById('dateTimeSection');

      // Helper to enable/disable Date Time Section
      function setDateTimeSectionEnabled(enabled) {
        if (enabled) {
          dateTimeSection.classList.remove('opacity-50', 'pointer-events-none');
        } else {
          dateTimeSection.classList.add('opacity-50', 'pointer-events-none');
          // Reset selections if disabled?
          // document.getElementById('date').value = '';
          // document.getElementById('timeGrid').innerHTML = '<p...>...</p>';
          // window.selectedSlotId = null;
          // window.updateNextButtonState();
        }
      }

      if (departmentSelect && doctorContainer) {
        departmentSelect.addEventListener('change', async function () {
          const department = this.value;
          doctorContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">กำลังโหลดข้อมูล...</p>';

          // Reset downstream
          selectedDoctorId = null;
          setDateTimeSectionEnabled(false);
          window.updateNextButtonState();

          try {
            const response = await fetch('/api/doctors?department=' + department);
            const doctors = await response.json();

            doctorContainer.innerHTML = '';

            if (doctors.length === 0) {
              doctorContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">ไม่พบรายชื่อแพทย์ในแผนกนี้</p>';
              return;
            }

            doctors.forEach(doctor => {
              const card = document.createElement('div');
              const isFull = doctor.status.includes('เต็ม') || doctor.status === 'ไม่ว่าง';

              card.className = 'border border-gray-200 rounded-lg p-4 transition doctor-card relative';
              if (isFull) {
                card.className += ' opacity-50 cursor-not-allowed bg-gray-50';
              } else {
                card.className += ' cursor-pointer hover:border-blue-300 hover:shadow-md';
              }

              card.dataset.name = doctor.name;
              card.dataset.id = doctor.id_doctor; // Important: Store ID

              card.innerHTML = `
                  <div class="flex items-center gap-4">
                    <div>
                      <p class="font-bold text-gray-800">${doctor.name}</p>
                      <p class="text-xs text-gray-500">${doctor.specialty}</p>
                      <p class="text-xs ${doctor.status_color} mt-1">${doctor.status}</p>
                    </div>
                  </div>
                  <div class="selected-icon absolute top-3 right-3 text-blue-600 hidden">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                  </div>
                `;

              // Add click event for selection only if not full
              if (!isFull) {
                card.addEventListener('click', function () {
                  // UI Updates
                  document.querySelectorAll('.doctor-card').forEach(c => {
                    c.classList.remove('selected', 'border-blue-500', 'bg-blue-50', 'border-2');
                    c.classList.add('border', 'border-gray-200');
                    if (!c.classList.contains('opacity-50')) c.classList.add('hover:border-blue-300', 'hover:shadow-md');
                    const icon = c.querySelector('.selected-icon');
                    if (icon) icon.classList.add('hidden');
                  });

                  this.classList.remove('border', 'border-gray-200', 'hover:border-blue-300', 'hover:shadow-md');
                  this.classList.add('selected', 'border-blue-500', 'bg-blue-50', 'border-2');
                  const icon = this.querySelector('.selected-icon');
                  if (icon) icon.classList.remove('hidden');

                  // Logic Updates
                  selectedDoctorId = this.dataset.id;
                  setDateTimeSectionEnabled(true);

                  // Refresh Slots if date is already picked
                  const dateVal = document.getElementById('date').value;
                  if (dateVal) {
                    window.renderTimeSlots();
                  }

                  window.updateNextButtonState();
                });
              }

              doctorContainer.appendChild(card);
            });

          } catch (e) {
            console.error(e);
            doctorContainer.innerHTML = '<p class="text-red-500 col-span-full text-center py-4">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>';
          }
        });
      }
    })();

    // -------------------------------------------------------------------------
    // 3. Date & Time Slot Logic (Ported from datetime.html)
    // -------------------------------------------------------------------------
    (function () {
      const timeGrid = document.getElementById('timeGrid');
      const dateInput = document.getElementById('date');

      // Function to fetch bookings and render slots
      window.renderTimeSlots = async function () {
        const date = dateInput.value;
        const doctorId = selectedDoctorId;

        timeGrid.innerHTML = ''; // Clear existing
        selectedSlotId = null; // Reset selection
        window.updateNextButtonState();

        if (!date || !doctorId) {
          timeGrid.innerHTML = '<p class="col-span-full text-gray-400 text-center py-4 text-sm">กรุณาเลือกแพทย์และวันที่</p>';
          return;
        }

        try {
          const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? (location.protocol + '//' + location.hostname + ':5000') : '';

          // Fetch Slots for this doctor (using ID now!)
          const resSlots = await fetch(`${API_BASE}/api/doctors/${doctorId}/slots`);
          let allSlots = await resSlots.json();

          // Filter by date
          // Also filter by doctor's status? (Backend doesn't enforcing it yet, but UI admin does). 
          // Assuming backend slots list is source of truth.
          const daySlots = allSlots.filter(s => s.slot_date === date);

          if (daySlots.length === 0) {
            timeGrid.innerHTML = '<p class="col-span-full text-gray-500 text-center py-4">ไม่มีตารางลงเวลานัดหมายในวันที่เลือก</p>';
            return;
          }

          // Sort by time
          daySlots.sort((a, b) => a.start_time.localeCompare(b.start_time));

          daySlots.forEach(slot => {
            const btn = document.createElement('button');
            const isFull = slot.current_booking >= slot.max_capacity;

            // Format time range
            const timeRange = `${slot.start_time.slice(0, 5)} - ${slot.end_time.slice(0, 5)}`;
            // Show capacity
            const capacityInfo = `(${slot.current_booking}/${slot.max_capacity})`;

            btn.innerHTML = `
               <div class="flex flex-col items-center leading-tight">
                 <span>${timeRange}</span>
                 <span class="text-xs ${isFull ? 'text-red-500' : 'text-gray-500'}">${capacityInfo}</span>
               </div>
            `;
            btn.dataset.slotId = slot.slot_id;

            btn.className = "py-2 px-1 text-sm border rounded transition font-medium flex items-center justify-center h-14 w-full"; // Added w-full

            if (isFull) {
              btn.classList.add('bg-gray-100', 'text-gray-400', 'border-gray-200', 'cursor-not-allowed');
              btn.disabled = true;
              btn.title = "เต็มแล้ว";
            } else {
              btn.classList.add('bg-white', 'text-gray-700', 'border-gray-200', 'hover:border-blue-500', 'hover:text-blue-600');
            }

            // Add Click Event
            if (!isFull) {
              btn.addEventListener('click', function (e) {
                e.preventDefault(); // Prevent bubbling issues

                // Deselect others
                const allBtns = timeGrid.querySelectorAll('button');
                allBtns.forEach(b => {
                  b.classList.remove('bg-blue-600', 'text-white', 'shadow-md', 'ring-2', 'ring-blue-300', 'border-transparent');
                  if (!b.disabled) b.classList.add('bg-white', 'text-gray-700', 'border-gray-200');
                });

                // Select this
                this.classList.remove('bg-white', 'text-gray-700', 'border-gray-200');
                this.classList.add('bg-blue-600', 'text-white', 'shadow-md', 'ring-2', 'ring-blue-300', 'border-transparent');

                // Update State
                selectedSlotId = slot.slot_id;
                window.selectedSlotId = slot.slot_id; // Global ref if needed
                selectedTimeString = timeRange;
                window.selectedTimeString = timeRange;

                window.updateNextButtonState();
              });
            }

            timeGrid.appendChild(btn);
          });

        } catch (e) {
          console.error("Error fetching slots:", e);
          timeGrid.innerHTML = '<p class="col-span-full text-red-500 text-center">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>';
        }
      };

      // Hook into date change
      dateInput.addEventListener('change', window.renderTimeSlots);
    })();

    // -------------------------------------------------------------------------
    // 4. User Status & Initial Load
    // -------------------------------------------------------------------------
    (function () {
      const userStatusLink = document.getElementById('userStatusLink');
      const userMenuBtn = document.getElementById('userMenuBtn');

      try {
        const user = JSON.parse(localStorage.getItem('mq_user'));
        if (user && user.name) {
          userStatusLink.textContent = user.name;
          userStatusLink.href = '#';
          userStatusLink.style.cursor = 'pointer';
          userMenuBtn.classList.remove('hidden');

          userStatusLink.addEventListener('click', function (e) {
            e.preventDefault();
            if (confirm('ออกจากระบบ?')) {
              localStorage.removeItem('mq_user');
              localStorage.removeItem('mq_registeredUser');
              window.location.reload();
            }
          });
        }
      } catch (e) {
      }
    })();
    // -------------------------------------------------------------------------
    // 5. Reschedule Logic (Auto-fill)
    // -------------------------------------------------------------------------
    (function () {
      const rescheduleId = localStorage.getItem('mq_rescheduleBookingId');
      if (!rescheduleId) return;

      // Auto-fill flow
      const deptVal = localStorage.getItem('mq_departmentValue');
      const docName = localStorage.getItem('mq_doctorName');
      const symptomsVal = localStorage.getItem('mq_symptoms');

      if (symptomsVal) document.getElementById('symptoms').value = symptomsVal;

      if (deptVal) {
        const deptSelect = document.getElementById('departmentSelect');
        deptSelect.value = deptVal;

        // Trigger change to load doctors
        const event = new Event('change');
        departmentSelect.dispatchEvent(event);

        // Wait for doctors to load then select
        let attempts = 0;
        const interval = setInterval(() => {
          attempts++;
          if (attempts > 30) clearInterval(interval); // 3 seconds max

          const doctorCards = document.querySelectorAll('.doctor-card');
          if (doctorCards.length > 0) {
            // Try to find the doctor
            let targetCard = null;
            doctorCards.forEach(card => {
              if (card.dataset.name === docName) targetCard = card;
            });

            if (targetCard) {
              targetCard.click();
              clearInterval(interval);
            }
          }
        }, 100);
      }
    })();
  </script>
</body>

</html>